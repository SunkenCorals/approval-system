# ä¼ä¸šçº§å®¡æ‰¹ç®¡ç†ç³»ç»Ÿ (Approval System)

## 1. é¡¹ç›®æ¦‚è¿°

**ðŸ”´ åœ¨çº¿æ¼”ç¤ºåœ°å€**: [https://approval-system-frontend-demo.vercel.app/approval](https://approval-system-frontend-demo.vercel.app/approval)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºŽ **React (Frontend)** å’Œ **NestJS (Backend)** æž„å»ºçš„å…¨æ ˆå®¡æ‰¹ç®¡ç†ç³»ç»Ÿã€‚ç³»ç»Ÿæ—¨åœ¨è§£å†³ä¼ä¸šå†…éƒ¨å¤æ‚çš„æµç¨‹å®¡æ‰¹éœ€æ±‚ï¼Œå®žçŽ°äº†ä»Žå®¡æ‰¹å•å‘èµ·ã€æµè½¬ã€å†³ç­–åˆ°å½’æ¡£çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

é¡¹ç›®æ ¸å¿ƒé‡‡ç”¨**å‰åŽç«¯åˆ†ç¦»**æž¶æž„ï¼Œå¼•å…¥äº†**åŠ¨æ€è¡¨å•å¼•æ“Ž**ã€**æœ‰é™çŠ¶æ€æœº (FSM)** ä»¥åŠ**RBAC åŸºç¡€æƒé™æŽ§åˆ¶**ç­‰æŠ€æœ¯æ–¹æ¡ˆï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„çµæ´»æ€§ã€å¯æ‰©å±•æ€§ä¸Žæ•°æ®ä¸€è‡´æ€§ã€‚

---

## 2. æŠ€æœ¯æž¶æž„ä¸Žé€‰åž‹

### 2.1 åŽç«¯æž¶æž„ (Backend)

åŽç«¯æœåŠ¡åŸºäºŽ **NestJS** æ¡†æž¶æž„å»ºï¼Œéµå¾ªæ¨¡å—åŒ–è®¾è®¡åŽŸåˆ™ã€‚

*   **Runtime**: Node.js
*   **Framework**: NestJS (IoC, AOP)
*   **Database**: SQLite (å¼€å‘çŽ¯å¢ƒ) / å¯æ— ç¼åˆ‡æ¢ MySQL/PostgreSQL
*   **ORM**: **Prisma** (Schema-First, ç±»åž‹å®‰å…¨)
*   **API Design**: RESTful API
*   **Validation**: `class-validator` + `class-transformer` (DTO å±‚æ ¡éªŒ)
*   **File Storage**: æœ¬åœ°æ–‡ä»¶å­˜å‚¨ (æ”¯æŒæ‰©å±•å¯¹è±¡å­˜å‚¨ OSS/S3)

### 2.2 å‰ç«¯æž¶æž„ (Frontend)

å‰ç«¯åº”ç”¨åŸºäºŽ **React 18** ç”Ÿæ€æž„å»ºï¼Œå¼ºè°ƒç»„ä»¶åŒ–ä¸Žå·¥ç¨‹è§„èŒƒã€‚

*   **Build Tool**: Vite
*   **Framework**: React 18 + TypeScript
*   **State Management**: **TanStack Query (React Query)** (æœåŠ¡ç«¯çŠ¶æ€åŒæ­¥ä¸Žç¼“å­˜)
*   **UI Library**: Ant Design 5
*   **CSS Architecture**: External CSS (æ ·å¼ä¸Žé€»è¾‘åˆ†ç¦»)
*   **Routing**: React Router v6

---

## 3. æ ¸å¿ƒåŠŸèƒ½è®¾è®¡ä¸Žå®žçŽ° (è¯¦ç»†è¯´æ˜Ž)

### 3.1 å®¡æ‰¹æµè½¬çŠ¶æ€æœº (FSM)

ç³»ç»Ÿæ ¸å¿ƒæµè½¬é€»è¾‘åŸºäºŽä¸¥æ ¼çš„**æœ‰é™çŠ¶æ€æœº (Finite State Machine)** è®¾è®¡ï¼Œä»¥ç¡®ä¿ä¸šåŠ¡æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œæœç»éžæ³•çŠ¶æ€è·ƒè¿ã€‚

**çŠ¶æ€å®šä¹‰ï¼š**
*   `PENDING` (å¾…å®¡æ‰¹): åˆå§‹çŠ¶æ€ã€‚ä»…åœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œç”³è¯·äººå¯æ’¤å›ž/ä¿®æ”¹ï¼Œå®¡æ‰¹äººå¯å®¡æ‰¹ã€‚
*   `APPROVED` (å·²é€šè¿‡): ç»ˆæ€ã€‚å®¡æ‰¹äººé€šè¿‡åŽè¿›å…¥ï¼Œä¸å¯é€†ã€‚
*   `REJECTED` (å·²é©³å›ž): ç»ˆæ€ã€‚å®¡æ‰¹äººé©³å›žåŽè¿›å…¥ã€‚æ”¯æŒâ€œé‡æ–°ç¼–è¾‘â€æœºåˆ¶ï¼Œç¼–è¾‘åŽç”Ÿæˆæ–°å•æ®æˆ–çŠ¶æ€é‡ç½®ä¸º PENDINGã€‚
*   `WITHDRAWN` (å·²æ’¤å›ž): ç»ˆæ€ã€‚ç”³è¯·äººä¸»åŠ¨æ’¤å›žã€‚åŒæ ·æ”¯æŒé‡æ–°ç¼–è¾‘ã€‚

**æµè½¬é€»è¾‘å›¾ï¼š**

```mermaid
stateDiagram-v2
    [*] --> PENDING: æäº¤ç”³è¯·
    PENDING --> APPROVED: å®¡æ‰¹äººé€šè¿‡
    PENDING --> REJECTED: å®¡æ‰¹äººé©³å›ž
    PENDING --> WITHDRAWN: ç”³è¯·äººä¸»åŠ¨æ’¤å›ž
    
    note right of REJECTED
      å•æ®è¢«é©³å›žåŽï¼Œç”³è¯·äººå¯ä¿®æ­£ä¿¡æ¯
      é‡æ–°æäº¤ï¼Œå•æ®å›žåˆ° PENDING çŠ¶æ€
    end note
    
    REJECTED --> PENDING: ä¿®æ­£åŽé‡æ–°æäº¤
    WITHDRAWN --> PENDING: ä¿®æ­£åŽé‡æ–°æäº¤
    APPROVED --> [*]
```

**å…³é”®å®žçŽ°ç»†èŠ‚ï¼š**
*   **åŽŸå­æ€§æ“ä½œ**ï¼šæ‰€æœ‰çŠ¶æ€å˜æ›´å‡åœ¨ Prisma äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°ä¸Žæµè½¬æ—¥å¿—å†™å…¥çš„åŽŸå­æ€§ã€‚
*   **ä¹è§‚é”æŽ§åˆ¶**ï¼šåœ¨å¹¶å‘å®¡æ‰¹åœºæ™¯ä¸‹ï¼Œåˆ©ç”¨ç‰ˆæœ¬å·æˆ–æ•°æ®åº“é”æœºåˆ¶ï¼ˆå½“å‰ç‰ˆæœ¬ä¾èµ–æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼‰é˜²æ­¢é‡å¤å®¡æ‰¹ã€‚

### 3.2 åŠ¨æ€è¡¨å•å¼•æ“Ž (Dynamic Form Engine) - Server-Driven UI

ä¸ºäº†åº”å¯¹ä¼ä¸šå®¡æ‰¹ä¸­è¡¨å•ç±»åž‹ç¹å¤šï¼ˆå¦‚è¯·å‡ã€æŠ¥é”€ã€é‡‡è´­ç­‰å­—æ®µå„å¼‚ï¼‰çš„ç—›ç‚¹ï¼Œç³»ç»Ÿå®žçŽ°äº†ä¸€å¥—**åŽç«¯é©±åŠ¨**çš„åŠ¨æ€è¡¨å•å¼•æ“Žã€‚

**è®¾è®¡åŽŸç†ï¼š**
1.  **Schema å®šä¹‰**ï¼šåŽç«¯ `FormConfig` è¡¨å­˜å‚¨ JSON æ ¼å¼çš„è¡¨å•å®šä¹‰ï¼Œè€Œéžç¡¬ç¼–ç åœ¨å‰ç«¯ã€‚
2.  **åè®®æ˜ å°„**ï¼šå‰ç«¯é€šè¿‡ `DynamicForm` ç»„ä»¶ï¼Œå°†åŽç«¯ Schema æ˜ å°„ä¸º Antd Form Itemã€‚
3.  **æ ¡éªŒæ³¨å…¥**ï¼šåŽç«¯å®šä¹‰çš„æ ¡éªŒè§„åˆ™ï¼ˆå¦‚ `required`, `maxCount`, `regex`ï¼‰åœ¨å‰ç«¯è‡ªåŠ¨è½¬åŒ–ä¸º Async Validatorï¼Œå®žçŽ°äº†**ä¸€æ¬¡å®šä¹‰ï¼ŒåŒç«¯æ ¡éªŒ**ã€‚

**Schema æ•°æ®ç»“æž„ç¤ºä¾‹ï¼š**
```json
[
  {
    "field": "projectName",
    "name": "é¡¹ç›®åç§°",
    "component": "Input",
    "props": { "placeholder": "è¯·è¾“å…¥é¡¹ç›®åç§°" },
    "validator": { "required": true, "maxCount": 50, "message": "é¡¹ç›®åç§°å¿…å¡«ä¸”ä¸è¶…è¿‡50å­—" }
  },
  {
    "field": "departmentIds",
    "name": "å½’å±žéƒ¨é—¨",
    "component": "DepartmentSelect", 
    "validator": { "required": true }
  }
]
```

### 3.3 äº¤äº’ä½“éªŒä¸Žå·¥ç¨‹åŒ–å®žè·µ

æœ¬é¡¹ç›®åœ¨å®žçŽ°åŠŸèƒ½çš„åŒæ—¶ï¼Œæžåº¦é‡è§†**ç”¨æˆ·ä½“éªŒ (UX)** ä¸Ž**ä»£ç å¯ç»´æŠ¤æ€§ (DX)**ã€‚

1.  **äº¤äº’è®¾è®¡ï¼šçŠ¶æ€å¯æ„ŸçŸ¥ (State Awareness)**
    *   **ç—›ç‚¹**ï¼šä¼ ç»Ÿè¡¨æ ¼åœ¨æ— æƒé™æ—¶ç›´æŽ¥éšè—æŒ‰é’®ï¼Œç”¨æˆ·å›°æƒ‘â€œä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½æ“ä½œï¼Ÿâ€ã€‚
    *   **ä¼˜åŒ–**ï¼šå®žçŽ°äº†**â€œæ“ä½œæŒ‰é’®å¸¸é©» + ç¦ç”¨æç¤ºâ€**æ¨¡å¼ã€‚
    *   **å®žçŽ°**ï¼š`ApprovalTable` ç»„ä»¶å†…éƒ¨å°è£…äº†çŠ¶æ€åˆ¤æ–­é€»è¾‘ã€‚å½“ç”¨æˆ·å¯¹å·²é€šè¿‡å•æ®å°è¯•æ’¤å›žæ—¶ï¼ŒæŒ‰é’®ç½®ç°å¹¶æ˜¾ç¤º Tooltipï¼šâ€œå®¡æ‰¹å·²é€šè¿‡ï¼Œå•æ®ä¸å¯æ’¤å›žâ€ã€‚è¿™æ˜¾è‘—é™ä½Žäº†ç”¨æˆ·çš„è®¤çŸ¥è´Ÿè·ã€‚

2.  **CSS æž¶æž„é‡æž„ï¼šå…³æ³¨ç‚¹åˆ†ç¦»**
    *   **ç—›ç‚¹**ï¼šæ—©æœŸå¼€å‘ä¸­å¤§é‡ä½¿ç”¨å†…è”æ ·å¼ (`style={{ marginTop: 20 }}`), å¯¼è‡´ JSX è‡ƒè‚¿ï¼Œæ ·å¼å¤ç”¨å›°éš¾ã€‚
    *   **ä¼˜åŒ–**ï¼šå»ºç«‹ `src/styles` ç›®å½•ï¼ŒæŒ‰é¡µé¢/ç»„ä»¶ç»´åº¦æ‹†åˆ† CSS æ–‡ä»¶ã€‚
    *   **æ”¶ç›Š**ï¼š
        *   JSX ä»£ç è¡Œæ•°å‡å°‘çº¦ 30%ï¼Œé€»è¾‘ç»“æž„æ›´æ¸…æ™°ã€‚
        *   æ ·å¼ç»Ÿä¸€ç®¡ç†ï¼Œæ–¹ä¾¿åŽç»­è¿›è¡Œ Dark Mode é€‚é…æˆ–ä¸»é¢˜è‰²å˜æ›´ã€‚

3.  **æ€§èƒ½ä¼˜åŒ–ï¼šéƒ¨é—¨æ ‘çš„é«˜æ•ˆæ¸²æŸ“**
    *   **åœºæ™¯**ï¼šéƒ¨é—¨é€‰æ‹©å™¨ (`DepartmentSelect`) éœ€è¦åŠ è½½å…¨é‡ç»„ç»‡æž¶æž„æ ‘ã€‚
    *   **ä¼˜åŒ–**ï¼šåˆ©ç”¨ **TanStack Query** çš„ç¼“å­˜æœºåˆ¶ã€‚é¦–æ¬¡åŠ è½½åŽï¼Œæ•°æ®é©»ç•™å†…å­˜ï¼ŒåŽç»­åˆ‡æ¢é¡µé¢æˆ–å¤šæ¬¡æ‰“å¼€å¼¹çª—æ—¶å®žçŽ°**é›¶å»¶è¿Ÿæ¸²æŸ“**ï¼Œé¿å…äº†é‡å¤çš„ API è°ƒç”¨ã€‚

---

## 4. æ•°æ®åº“è®¾è®¡ (ERD è¯¦è§£)

åŸºäºŽ Prisma Schema çš„æ•°æ®æ¨¡åž‹è®¾è®¡ï¼Œéµå¾ªç¬¬ä¸‰èŒƒå¼ï¼Œå…¼é¡¾æŸ¥è¯¢æ€§èƒ½ã€‚

### 4.1 æ ¸å¿ƒå®žä½“å…³ç³»å›¾

```mermaid
erDiagram
    Approval ||--o{ Attachment : "has (1:N)"
    Approval {
        int id PK
        string serialNo "å”¯ä¸€å•å·"
        string status "çŠ¶æ€æžšä¸¾"
        string content "JSONå†…å®¹å¿«ç…§"
        datetime createdAt
        string creatorId
        string approverId
    }
    Attachment {
        int id PK
        int approvalId FK
        string filename
        string path "å­˜å‚¨è·¯å¾„"
        string type "æ–‡ä»¶ç±»åž‹"
    }
    FormConfig {
        int id PK
        string key "è¡¨å•å”¯ä¸€æ ‡è¯†"
        string schema "JSON Schemaå®šä¹‰"
    }
    Department {
        string id PK
        string parentId "çˆ¶éƒ¨é—¨ID"
        string path "ç‰©åŒ–è·¯å¾„ (e.g. /1/5/10)"
    }
```

### 4.2 å…³é”®è®¾è®¡å†³ç­–

1.  **Approval.departmentPath (åèŒƒå¼è®¾è®¡)**
    *   **å†³ç­–**ï¼šåœ¨å®¡æ‰¹å•ä¸»è¡¨ä¸­å†—ä½™å­˜å‚¨ `departmentPath`ï¼ˆå¦‚ "æŠ€æœ¯éƒ¨-åŽç«¯ç»„"ï¼‰ã€‚
    *   **ç†ç”±**ï¼šé¿å…åœ¨åˆ—è¡¨æŸ¥è¯¢æ—¶è¿›è¡Œå¤æ‚çš„é€’å½’è”è¡¨æŸ¥è¯¢ï¼ˆN+1 é—®é¢˜ï¼‰ï¼Œå¤§å¹…æå‡åˆ—è¡¨é¡µåŠ è½½é€Ÿåº¦ã€‚

2.  **FormConfig.schema (JSON ç±»åž‹)**
    *   **å†³ç­–**ï¼šä½¿ç”¨æ–‡æœ¬/JSON ç±»åž‹å­˜å‚¨è¡¨å•é…ç½®ã€‚
    *   **ç†ç”±**ï¼šè¡¨å•ç»“æž„å¤šå˜ï¼ŒNoSQL å¼çš„å­˜å‚¨æä¾›äº†æœ€å¤§çš„çµæ´»æ€§ï¼Œæ”¯æŒçƒ­æ›´æ–°è¡¨å•ç»“æž„è€Œæ— éœ€å˜æ›´æ•°æ®åº“ Schemaã€‚

3.  **Department.path (ç‰©åŒ–è·¯å¾„)**
    *   **å†³ç­–**ï¼šå­˜å‚¨éƒ¨é—¨å±‚çº§è·¯å¾„ï¼ˆå¦‚ `/root/dev/backend`ï¼‰ã€‚
    *   **ç†ç”±**ï¼šæ”¯æŒé«˜æ•ˆçš„å­æ ‘æŸ¥è¯¢ï¼ˆ`startswith`ï¼‰å’Œé¢åŒ…å±‘å¯¼èˆªç”Ÿæˆï¼Œé¿å…é€’å½’ CTE æŸ¥è¯¢å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚

---

## 5. æœ¬åœ°æž„å»ºä¸Žè¿è¡Œ

### çŽ¯å¢ƒè¦æ±‚
*   Node.js >= 16
*   npm æˆ– pnpm

### 5.1 åŽç«¯æœåŠ¡ (Backend)

```bash
cd backend

# 1. å®‰è£…ä¾èµ–
npm install

# 2. æ•°æ®åº“è¿ç§» (åˆå§‹åŒ– SQLite)
npm run prisma:generate
npm run prisma:migrate

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (Port: 3001)
npm run dev
```

### 5.2 å‰ç«¯æœåŠ¡ (Frontend)

```bash
cd frontend

# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (Port: 5173)
npm run dev
```

è®¿é—®æµè§ˆå™¨ `http://localhost:5173` å³å¯è¿›å…¥ç³»ç»Ÿã€‚

---

## 6. éƒ¨ç½² (Deployment)

æœ¬é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²è‡³ **Vercel**ï¼Œå¹¶é‡‡ç”¨ **Serverless** æž¶æž„è¿è¡Œã€‚

*   **å‰ç«¯**: éƒ¨ç½²åœ¨ Vercel Edge Networkï¼Œé€šè¿‡ Rewrite è§„åˆ™æ”¯æŒ SPA è·¯ç”±ã€‚
*   **åŽç«¯**: éƒ¨ç½²ä¸º Vercel Serverless Function (Node.js)ï¼Œé€šè¿‡ `/api` è·¯ç”±å¤„ç†è¯·æ±‚ã€‚
*   **æ•°æ®åº“**: ä½¿ç”¨ **Neon (Serverless Postgres)**ï¼Œå®žçŽ°äº†è®¡ç®—ä¸Žå­˜å‚¨çš„åˆ†ç¦»ã€‚
*   **æ–‡ä»¶å­˜å‚¨**: é€‚é…äº† Vercel Serverless çŽ¯å¢ƒï¼Œä½¿ç”¨ `/tmp` ä¸´æ—¶ç›®å½•å¤„ç†æ–‡ä»¶ä¸Šä¼  (ç”Ÿäº§çŽ¯å¢ƒå»ºè®®å¯¹æŽ¥ S3)ã€‚

**éƒ¨ç½²æž¶æž„å›¾:**

```mermaid
graph TD
    User[ç”¨æˆ·] -->|HTTPS| Vercel[Vercel Edge Network]
    Vercel -->|Static Assets| Frontend[React SPA]
    Vercel -->|/api/*| Backend[NestJS Serverless Function]
    Backend -->|TCP/SSL| DB[(Neon Postgres)]
```
